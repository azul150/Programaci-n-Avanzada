<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestión de Cursos</title>
    <script src="tau-prolog.js"></script>
    <script src="tau-prolog/modules/lists.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #2c3e50; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; }
        select, button { width: 100%; padding: 10px; border-radius: 6px; }
        button { background: #3498db; color: #fff; border: none; cursor: pointer; margin-top: 10px; }
        button:hover { background: #2980b9; }
        .result { margin-top: 20px; padding: 15px; border-radius: 6px; background: #f8f9fa; }
    </style>
</head>
<body>
<div class="container">
    <h1>Sistema de Gestión de Cursos</h1>
    
    <div class="form-group">
        <label for="alumno">Selecciona un alumno:</label>
        <select id="alumno">
            <option value="maria">Maria</option>
            <option value="carlos">Carlos</option>
            <option value="laura">Laura</option>
            <option value="juan">Juan</option>
        </select>
    </div>
    
    <div class="form-group">
        <label for="curso">Selecciona un curso:</label>
        <select id="curso">
            <option value="calculo_diferencial">Cálculo Diferencial</option>
            <option value="calculo_integral">Cálculo Integral</option>
            <option value="programacion1">Programación 1</option>
            <option value="programacion2">Programación 2</option>
            <option value="algoritmos">Algoritmos</option>
            <option value="fisica1">Física 1</option>
            <option value="ingles1">Inglés 1</option>
            <option value="ingles2">Inglés 2</option>
        </select>
    </div>
    
    <button onclick="consulta()">¿Puede cursar?</button>
    
    <div id="resultado" class="result"></div>
</div>

<script>
    const prologCode = `
        % --- Materias ---
        materia(calculo_diferencial).
        materia(calculo_integral).
        materia(programacion1).
        materia(programacion2).
        materia(algoritmos).
        materia(fisica1).
        materia(ingles1).
        materia(ingles2).

        % --- Cursos aprobados ---
        aprobada(maria, calculo_diferencial).
        aprobada(maria, programacion1).
        aprobada(juan, calculo_diferencial).
        aprobada(laura, programacion1).
        aprobada(carlos, calculo_diferencial).
        aprobada(carlos, ingles1).
        aprobada(carlos, fisica1).

        % --- Requisitos ---
        requisito(calculo_integral, calculo_diferencial).
        requisito(programacion2, programacion1).
        requisito(algoritmos, programacion1).
        requisito(ingles2, ingles1).

        % --- Estados de los cursos ---
        % Caso 1: Ya aprobó el curso
        estado_curso(Alumno, Curso, ya_aprobado) :-
            aprobada(Alumno, Curso).

        % cumple requisitos y no lo ha aprobado antes
        estado_curso(Alumno, Curso, puede_cursar) :-
            materia(Curso),
            \\+ aprobada(Alumno, Curso),
            forall(requisito(Curso, Pre), aprobada(Alumno, Pre)).

        % le faltan requisitos
        estado_curso(Alumno, Curso, no_puede) :-
            materia(Curso),
            \\+ aprobada(Alumno, Curso),
            (requisito(Curso, Pre), \\+ aprobada(Alumno, Pre)).

        % --- Requisitos faltantes ---
        faltan(Alumno, Curso, X) :-
            findall(Pre, (requisito(Curso, Pre), \\+ aprobada(Alumno, Pre)), X).
    `;

    const session = pl.create();
    session.consult(prologCode);

    // Consulta estado del curso
    function consulta(){
        const alumno = document.getElementById("alumno").value;
        const curso = document.getElementById("curso").value;
        const query = `estado_curso(${alumno},${curso},Estado).`;
        
        session.query(query);
        session.answer(answer => {
            if (pl.type.is_substitution(answer)){
                const estado = answer.lookup("Estado").id;
                if (estado === "ya_aprobado") {
                    document.getElementById("resultado").innerHTML = 
                        `<b>${alumno}</b> ya aprobó <b>${curso.replace("_"," ")}</b>, no puede volver a cursarlo.`;
                } else if (estado === "puede_cursar") {
                    document.getElementById("resultado").innerHTML = 
                        `<b>${alumno}</b> SÍ puede cursar <b>${curso.replace("_"," ")}</b>.`;
                } else if (estado === "no_puede") {
                    consulta_faltantes(true);
                }
            } else {
                document.getElementById("resultado").innerHTML = "No se encontró información.";
            }
        });
    }

    // Consulta: faltan
    function consulta_faltantes(fromConsulta=false){
        const alumno = document.getElementById("alumno").value;
        const curso = document.getElementById("curso").value;
        const query = `faltan(${alumno},${curso},X).`;

        session.query(query);
        session.answer(answer => {
            if (pl.type.is_substitution(answer)){
                const faltantes = answer.lookup("X");
                let lista = [];

                if (faltantes.indicator === "./2") {
                    let node = faltantes;
                    while (node.indicator === "./2") {
                        lista.push(node.args[0].id.replace("_"," "));
                        node = node.args[1];
                    }
                }

                if (lista.length > 0){
                    document.getElementById("resultado").innerHTML = 
                        `<b>${alumno}</b> NO puede cursar <b>${curso.replace("_"," ")}</b> porque le falta: ${lista.join(", ")}`;
                } else if(!fromConsulta) {
                    document.getElementById("resultado").innerHTML = 
                        `<b>${alumno}</b> no necesita requisitos adicionales para <b>${curso.replace("_"," ")}</b>`;
                }
            } else if(!fromConsulta) {
                document.getElementById("resultado").innerHTML = 
                    `<b>${alumno}</b> no necesita requisitos adicionales para <b>${curso.replace("_"," ")}</b>`;
            }
        });
    }
</script>
</body>
</html>